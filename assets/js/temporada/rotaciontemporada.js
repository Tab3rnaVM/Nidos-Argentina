const eventosData = {
  titulo: "Caminos Valiosos",
  fechas: {
    inicio: "2025-12-02T10:00:00",
    fin: "2026-03-03T10:00:00",
  },
  secciones: [
    {
      titulo: "Logro de investigación",
      subtitulo: "",
      icono: "../../assets/images/temporada/logro-de-investigacion.png",
      items: [
        {
          nombre: "Mr. Mime de Galar",
          imagen: "../../assets/images/pokemon/pm122.fGALARIAN.icon.webp",
          shinyImage: "../../assets/images/pokemon/pm122.fGALARIAN.s.icon.webp",
          shiny: true,
        },
        {
          nombre: "Lapras",
          imagen: "../../assets/images/pokemon/pm131.icon.webp",
          shinyImage: "../../assets/images/pokemon/pm131.s.icon.webp",
          shiny: true,
        },
        {
          nombre: "Snorlax",
          imagen: "../../assets/images/pokemon/pm143.icon.webp",
          shinyImage: "../../assets/images/pokemon/pm143.s.icon.webp",
          shiny: true,
        },
        {
          nombre: "Honedge",
          imagen: "../../assets/images/pokemon/pm679.icon.webp",
          shiny: false,
        },
        {
          nombre: "Sinistea",
          imagen: "../../assets/images/pokemon/pm854.icon.webp",
          shinyImage: "../../assets/images/pokemon/pm854.s.icon.webp",
          shiny: true,
        },
        {
          nombre: "Dreepy",
          imagen: "../../assets/images/pokemon/pm885.icon.webp",
          shiny: false,
        },
      ],
    },

    /* ===== Estado salvaje (Historias de Transformación NO APLICA) ===== */
    // (se mantiene comentado tal cual lo tienes)

    /* ===== Huevos (ACTUALIZADOS) ===== */
    {
      titulo: "Huevos",
      subtitulo: "2km",
      icono: "../../assets/images/huevos/huevo-2km.png",
      items: [
        {
          nombre: "Cleffa",
          imagen: "../../assets/images/pokemon/pm173.icon.webp",
          shinyImage: "../../assets/images/pokemon/pm173.s.icon.webp",
          shiny: true,
        },
        {
          nombre: "Smoochum",
          imagen: "../../assets/images/pokemon/pm238.icon.webp",
          shinyImage: "../../assets/images/pokemon/pm238.s.icon.webp",
          shiny: true,
        },
        {
          nombre: "Bergmite",
          imagen: "../../assets/images/pokemon/pm712.icon.webp",
          shinyImage: "../../assets/images/pokemon/pm712.s.icon.webp",
          shiny: true,
        },
      ],
    },
    {
      titulo: "Huevos",
      subtitulo: "5km",
      icono: "../../assets/images/huevos/huevo-5km.png",
      items: [
        {
          nombre: "Audino",
          imagen: "../../assets/images/pokemon/pm531.icon.webp",
          shinyImage: "../../assets/images/pokemon/pm531.s.icon.webp",
          shiny: true,
        },
        {
          nombre: "Elgyem",
          imagen: "../../assets/images/pokemon/pm605.icon.webp",
          shinyImage: "../../assets/images/pokemon/pm605.s.icon.webp",
          shiny: true,
        },
        {
          nombre: "Snom",
          imagen: "../../assets/images/pokemon/pm872.icon.webp",
          shiny: false,
        },
      ],
    },
    {
      titulo: "Huevos",
      subtitulo: "5km Sincroaventura",
      icono: "../../assets/images/huevos/huevo-5km-sincroaventura.png",
      items: [
        {
          nombre: "Bonsly",
          imagen: "../../assets/images/pokemon/pm438.icon.webp",
          shinyImage: "../../assets/images/pokemon/pm438.s.icon.webp",
          shiny: true,
        },
        {
          nombre: "Riolu",
          imagen: "../../assets/images/pokemon/pm447.icon.webp",
          shinyImage: "../../assets/images/pokemon/pm447.s.icon.webp",
          shiny: true,
        },
        {
          nombre: "Archen",
          imagen: "../../assets/images/pokemon/pm566.icon.webp",
          shinyImage: "../../assets/images/pokemon/pm566.s.icon.webp",
          shiny: true,
        },
      ],
    },
    {
      titulo: "Huevos",
      subtitulo: "7km",
      icono: "../../assets/images/huevos/huevo-7km.png",
      items: [
        {
          nombre: "Diglett de Alola",
          imagen: "../../assets/images/pokemon/pm50.fALOLA.icon.webp",
          shinyImage: "../../assets/images/pokemon/pm50.fALOLA.s.icon.webp",
          shiny: true,
        },
        {
          nombre: "Zigzagoon de Galar",
          imagen: "../../assets/images/pokemon/pm263.fGALARIAN.icon.webp",
          shinyImage: "../../assets/images/pokemon/pm263.fGALARIAN.s.icon.webp",
          shiny: true,
        },
        {
          nombre: "Stunfisk de Galar",
          imagen: "../../assets/images/pokemon/pm618.fGALARIAN.icon.webp",
          shinyImage: "../../assets/images/pokemon/pm618.fGALARIAN.s.icon.webp",
          shiny: true,
        },
      ],
    },
    {
      titulo: "Huevos",
      subtitulo: "7 km del intercambio con Mateo",
      icono: "../../assets/images/huevos/huevo-7km-mateo.png",
      items: [
        {
          nombre: "Growlithe de Hisui",
          imagen: "../../assets/images/pokemon/pm58.fHISUIAN.icon.webp",
          shinyImage: "../../assets/images/pokemon/pm58.fHISUIAN.s.icon.webp",
          shiny: true,
        },
        {
          nombre: "Slowpoke de Galar",
          imagen: "../../assets/images/pokemon/pm79.fGALARIAN.icon.webp",
          shinyImage: "../../assets/images/pokemon/pm79.fGALARIAN.s.icon.webp",
          shiny: true,
        },
        {
          nombre: "Basculin (Raya Blanca)",
          imagen: "../../assets/images/pokemon/pm550.fWHITE_STRIPED.icon.webp",
          shinyImage: "../../assets/images/pokemon/pm550.fWHITE_STRIPED.s.icon.webp",
          shiny: true,
        },
      ],
    },
    {
      titulo: "Huevos",
      subtitulo: "10km",
      icono: "../../assets/images/huevos/huevo-10km.png",
      items: [
        {
          nombre: "Beldum",
          imagen: "../../assets/images/pokemon/pm374.icon.webp",
          shinyImage: "../../assets/images/pokemon/pm374.s.icon.webp",
          shiny: true,
        },
        {
          nombre: "Tinkatink",
          imagen: "../../assets/images/pokemon/pm957.icon.webp",
          shinyImage: "../../assets/images/pokemon/pm957.s.icon.webp",
          shiny: true,
        },
      ],
    },
    {
      titulo: "Huevos",
      subtitulo: "10km Sincroaventura",
      icono: "../../assets/images/huevos/huevo-10km-sincroaventura.png",
      items: [
        {
          nombre: "Beldum",
          imagen: "../../assets/images/pokemon/pm374.icon.webp",
          shinyImage: "../../assets/images/pokemon/pm374.s.icon.webp",
          shiny: true,
        },
        {
          nombre: "Drampa",
          imagen: "../../assets/images/pokemon/pm780.icon.webp",
          shinyImage: "../../assets/images/pokemon/pm780.s.icon.webp",
          shiny: true,
        },
        {
          nombre: "Dreepy",
          imagen: "../../assets/images/pokemon/pm885.icon.webp",
          shiny: false,
        },
      ],
    },
  ],

  bonus: [
    {
      texto: "Un intercambio especial adicional al día.",
      icono: "../../assets/images/bonus/intercambio-bonus.png",
    },
    {
      texto: "Más Polvos Estrella por la primera captura del día.",
      icono: "../../assets/images/bonus/polvos-bonus.png",
    },
    {
      texto: "Mayor daño causado por los Pokémon en incursiones gracias a la bonificación de amistad.",
      icono: "../../assets/images/bonus/raid-bonus.png",
    },
  ],
};


/* ---------- Utilidades de resource hints ---------- */

// Crea/actualiza <link rel="preload|prefetch"> en <head> de forma segura
function setPreloadLinks(
  urls,
  { as = "image", rel = "preload", dataTag = "event-preload", limit = 12 } = {}
) {
  // Limpia links previos de este “grupo”
  document.head
    .querySelectorAll(`link[rel="${rel}"][data-tag="${dataTag}"]`)
    .forEach((n) => n.remove());

  const uniques = [...new Set(urls)].slice(0, limit);
  uniques.forEach((href) => {
    if (!href) return;
    const link = document.createElement("link");
    link.rel = rel;
    if (as) link.as = as;
    link.href = href;
    link.dataset.tag = dataTag;
    document.head.appendChild(link);
  });
}

// Prefetch (baja prioridad) para el resto de imágenes
function setPrefetchLinks(urls) {
  setPreloadLinks(urls, { rel: "prefetch", as: "", dataTag: "event-prefetch", limit: 32 });
}

// Extrae todas las urls de imágenes (normal + shiny) del evento
function collectEventImageURLs(eventData) {
  const urls = [];
  eventData.secciones.forEach((seccion) => {
    // items directos
    if (seccion.items) {
      seccion.items.forEach((item) => {
        urls.push(item.imagen);
        if (item.shiny && item.shinyImage) urls.push(item.shinyImage);
      });
    }
    // items por días (si existieran)
    if (seccion.dias) {
      seccion.dias.forEach((dia) => {
        (dia.items || []).forEach((item) => {
          urls.push(item.imagen);
          if (item.shiny && item.shinyImage) urls.push(item.shinyImage);
        });
      });
    }
  });
  return urls.filter(Boolean);
}

// Inyecta preloads (primeras N imágenes) y prefetch (resto)
function injectResourceHintsForEvent(eventData) {
  const all = collectEventImageURLs(eventData);
  const PRELOAD_LIMIT = 12; // ajusta según tu layout “above-the-fold”
  const preloads = all.slice(0, PRELOAD_LIMIT);
  const prefetches = all.slice(PRELOAD_LIMIT);
  setPreloadLinks(preloads, { as: "image", rel: "preload", dataTag: "event-preload", limit: PRELOAD_LIMIT });
  setPrefetchLinks(prefetches);
}

/* ---------- Pre-carga (JS) para hover shiny ---------- */

function preloadShinyImages(eventData) {
  eventData.secciones.forEach((seccion) => {
    const ensure = (it) => {
      if (!it) return;
      if (it.shiny && it.shinyImage) {
        const shiny = new Image();
        shiny.src = it.shinyImage;
      }
      // calentamos también la normal (rápido en caché)
      if (it.imagen) {
        const normal = new Image();
        normal.src = it.imagen;
      }
    };
    if (seccion.items) seccion.items.forEach(ensure);
    if (seccion.dias) seccion.dias.forEach((d) => (d.items || []).forEach(ensure));
  });
}

/* ---------- Hover shiny ---------- */

function applyShinyHoverEffects() {
  const shinyIcons = document.querySelectorAll(".shiny-hover");
  shinyIcons.forEach((icon) => {
    const images = JSON.parse(icon.dataset.images);
    const pokemonImage = icon.closest(".thumb").querySelector(".pokemon-image");
    if (!pokemonImage) return;
    icon.addEventListener("mouseover", () => (pokemonImage.src = images[1]));
    icon.addEventListener("mouseout", () => (pokemonImage.src = images[0]));
  });
}

/* ---------- Render ---------- */

function renderEvento(eventData) {
  // Hints de recursos antes de renderizar
  injectResourceHintsForEvent(eventData);

  const container = document.getElementById("eventoContainer");

  // Renderizar el título y las fechas
  container.innerHTML = `
    <div class="secciontitle">
      <div class="col-lg-12">
        <div class="heading-section">
          <h4>${eventData.titulo}</h4>
        </div>
      </div>
    </div>
    <div class="col-lg-12" style="margin-top: 15px; padding: 0 !important">
      <div class="sub-secciontitle" style="margin-bottom: 0 !important">
        <p class="subtitles-blancos">
          Del ${new Date(eventData.fechas.inicio).toLocaleDateString("es-ES", { day: "2-digit", month: "long" })}
          (${new Date(eventData.fechas.inicio).toLocaleTimeString("en-US", { hour: "2-digit", minute: "2-digit" })})
          hasta el ${new Date(eventData.fechas.fin).toLocaleDateString("es-ES", { day: "2-digit", month: "long" })}
          (${new Date(eventData.fechas.fin).toLocaleTimeString("en-US", { hour: "2-digit", minute: "2-digit" })})
        </p>
      </div>
    </div>
  `;

  // Para marcar prioridades/lazy en las primeras tarjetas
  let renderIndex = 0;
  const HIGH_PRIORITY_LIMIT = 12; // las primeras N imágenes con mayor prioridad

  // Helpers de HTML
  const renderPokemonCard = (item) => {
    const isHigh = renderIndex < HIGH_PRIORITY_LIMIT;
    const priorityAttr = isHigh ? 'fetchpriority="high"' : 'loading="lazy"';
    renderIndex++;

    return `
      <div class="item item-pkmEvent ${item.raro ? "raro" : ""}">
        <div class="thumb thumb-pkmEvent">
          <img
            src="${item.imagen}"
            alt="${item.nombre}"
            class="pokemon-image"
            ${priorityAttr}
            decoding="async"
          />
          ${
            item.shiny
              ? `<div class="shiny-icon">
                   <img
                     src="../../assets/images/simbolos-incursiones/shiny.png"
                     alt="shiny"
                     class="shiny-hover"
                     data-images='["${item.imagen}", "${item.shinyImage}"]'
                   />
                 </div>`
              : ""
          }
          <div class="pokemon-name">${item.nombre}</div>
        </div>
      </div>
    `;
  };

  // Renderizar secciones
  eventData.secciones.forEach((seccion) => {
    let sectionHTML = `
      <div class="seccioncontainer" style="margin-top: 15px">
        <div class="titulo-icono">
          <div class="avatar">
            <img src="${seccion.icono}" alt="${seccion.titulo}" style="max-width: 46px; border-radius: 50%" />
          </div>
          <h3>${seccion.titulo}<br /><span>${seccion.subtitulo || ""}</span></h3>
        </div>
    `;

    // Secciones con días
    if (seccion.dias) {
      sectionHTML += seccion.dias
        .map((dia) => {
          const cards =
            (dia.items || []).length > 0
              ? dia.items.map((item) => renderPokemonCard(item)).join("")
              : `<p class="no-data">No hay elementos disponibles para este día.</p>`;
          return `
            <div class="sub-secciontitle" style="margin-top: 15px !important">
              <p class="subtitles-blancos">Los días ${dia.fecha}</p>
            </div>
            <div class="imagenes-grid">
              ${cards}
            </div>
          `;
        })
        .join("");
    }
    // Secciones con items directos
    else if (seccion.items) {
      sectionHTML += `
        <div class="imagenes-grid">
          ${
            seccion.items.length > 0
              ? seccion.items.map((item) => renderPokemonCard(item)).join("")
              : `<p class="no-data">No hay elementos disponibles para esta sección.</p>`
          }
        </div>
        ${
          seccion.textoAdicional
            ? seccion.textoAdicional.map((linea) => `<p class="info-adicional">${linea}</p>`).join("")
            : ""
        }
      `;
    }
    // Sin datos
    else {
      sectionHTML += `<p class="no-data">No hay elementos disponibles para esta sección.</p>`;
    }

    sectionHTML += `</div>`;
    container.innerHTML += sectionHTML;
  });

  // Banners antes de los bonus
  container.innerHTML += `
    <div class="footer-container">
      <div class="footer-banner">
        <span class="shiny-icon-circle">
          <img
            src="../../assets/images/simbolos-incursiones/shiny.png"
            alt="shiny icon"
            class="shiny-icon"
          />
        </span>
        <span>Posibilidad de Brillante</span>
      </div>
    </div>
  `;

  // Bonus
  if (eventData.bonus && eventData.bonus.length > 0) {
    container.innerHTML += `
      <div class="bonus-list">
        <div class="titulo-bonus" style="margin-bottom: 0 !important">
          <h3>Bonus del evento<br /></h3>
        </div>
        ${eventData.bonus
          .map(
            (bonus) => `
              <div class="bonus-item">
                <img src="${bonus.icono}" alt="Bonus" class="bonus-icon" loading="lazy" decoding="async" />
                <p>${bonus.texto}</p>
              </div>
            `
          )
          .join("")}
      </div>
    `;
  }

  // Precarga para hover shiny (memoria/caché)
  preloadShinyImages(eventData);

  // Activa hovers
  applyShinyHoverEffects();
}

/* ---------- Init ---------- */
window.addEventListener("load", () => {
  renderEvento(eventosData);
});

